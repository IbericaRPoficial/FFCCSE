<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FFCCSE ¬∑ Panel Operativo Completo</title>

<style>
:root {
    --bg-dark: #0a0c0f;
    --bg-card: #161b22;
    --bg-input: #0d1117;
    --text-main: #e6edf3;
    --text-muted: #8b949e;
    
    /* Bordes Cuerpos */
    --cnp-border: #1f6feb;
    --gc-border: #238636;
    --common-border: #e3b341;
    --color-border: #30363d;
}

body {
    font-family: 'Segoe UI', Roboto, sans-serif;
    background: var(--bg-dark);
    color: var(--text-main);
    margin: 0;
    padding: 20px;
    box-sizing: border-box;
}

/* === LAYOUT PRINCIPAL (Dos columnas: Unidades | Panel) === */
.app-container {
    display: grid;
    grid-template-columns: 1fr 280px;
    gap: 20px;
    max-width: 1900px;
    margin: 0 auto;
}

@media (max-width: 900px) { .app-container { grid-template-columns: 1fr; } }

/* === HEADER === */
header {
    grid-column: 1 / -1;
    text-align: center;
    margin-bottom: 10px;
    border-bottom: 1px solid var(--color-border);
    padding-bottom: 10px;
}
h2 { margin: 0; text-transform: uppercase; letter-spacing: 2px; color: var(--text-main); }

/* === ZONA UNIDADES (IZQUIERDA) === */
.units-area { display: flex; flex-direction: column; gap: 20px; }

/* Secci√≥n Conjunta (Arriba) */
.top-section {
    border-left: 5px solid var(--common-border);
    background: var(--bg-card);
    border-radius: 6px;
    padding: 15px;
}

/* Secci√≥n Dividida (CNP / GC) */
.split-section { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
@media (max-width: 700px) { .split-section { grid-template-columns: 1fr; } }

/* Columnas de Cuerpo */
.col-org {
    background: var(--bg-card);
    border-radius: 8px;
    padding: 15px;
    border-top: 4px solid #333;
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.col-cnp { border-color: var(--cnp-border); }
.col-gc { border-color: var(--gc-border); }

.col-title {
    text-align: center; font-weight: bold; font-size: 1.1em;
    padding-bottom: 10px; border-bottom: 1px solid var(--color-border);
    margin-bottom: 5px; text-transform: uppercase;
}

/* Cajas de Categor√≠a (ej. Seguridad Ciudadana) */
.unidad-base {
    border: 1px solid var(--color-border);
    border-radius: 6px;
    padding: 10px;
    background: #0d1117;
}
.unidad-base h3 {
    margin: 0 0 10px; font-size: 0.85em; color: var(--text-muted);
    border-bottom: 1px dashed var(--color-border); padding-bottom: 5px; text-transform: uppercase;
}

.sub-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 6px;
}

/* === CAJAS DE UNIDAD INDIVIDUALES === */
.sub-box {
    background: #1f242c;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    padding: 8px 4px;
    text-align: center;
    cursor: pointer;
    transition: 0.2s;
    min-height: 50px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.sub-box strong { display: block; margin-bottom: 3px; color: #fff; font-size: 11px; }

/* === COLORES DE ESTADO (L√≥gica solicitada) === */
.box-green {
    border-color: #238636 !important;
    background: rgba(35, 134, 54, 0.25) !important;
}
.box-red {
    border-color: #da3633 !important;
    background: rgba(218, 54, 51, 0.25) !important;
}
.box-yellow {
    border-color: #d29922 !important;
    background: rgba(210, 153, 34, 0.25) !important;
}
.sub-box:hover { filter: brightness(1.3); }

.mini-badge {
    color: #fff;
    padding: 1px 5px;
    border-radius: 3px;
    font-size: 9px;
    margin-top: 2px;
    font-weight: bold;
    text-shadow: 0 1px 2px #000;
}

/* === PANEL LATERAL (DERECHA) === */
.sidebar {
    background: var(--bg-card);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    padding: 20px;
    height: fit-content;
    position: sticky;
    top: 20px;
}
.sidebar h3 { margin-top:0; color:var(--text-muted); font-size:0.9rem; text-transform:uppercase; border-bottom:1px solid var(--color-border); padding-bottom:10px; }

.status-display {
    background: #0d1117; padding: 15px; border-radius: 4px;
    margin-bottom: 20px; text-align: center; border: 1px solid var(--color-border);
}
.form-group { margin-bottom: 15px; }
.form-group label { display: block; font-size: 12px; margin-bottom: 5px; color: var(--text-muted); }

input, select, button {
    width: 100%; padding: 12px; background: var(--bg-input);
    border: 1px solid var(--color-border); color: white;
    border-radius: 4px; box-sizing: border-box; font-size: 14px;
}
button { cursor: pointer; font-weight: bold; background: #1f6feb; border: none; margin-top: 5px; }
button:hover { opacity: 0.9; }
button.rojo { background: #da3633; margin-top: 10px; }
button.gris { background: #30363d; margin-top: 10px; }

.selected-unit-display {
    margin-bottom: 15px; padding: 10px; background: rgba(31, 111, 235, 0.1);
    border: 1px solid #1f6feb; border-radius: 4px; font-size: 0.9rem;
    text-align: center; display: none; color: #58a6ff;
}
</style>
</head>

<body>

<div class="app-container">
    
    <header><h2>FFCCSE - UNIDADES</h2></header>

    <div class="units-area">
        
        <div class="top-section" id="colComun">
            <div class="col-title" style="color:#e3b341">Unidades Conjuntas</div>
            </div>

        <div class="split-section">
            <div class="col-org col-cnp" id="colCNP">
                <div class="col-title" style="color:#58a6ff">CNP</div>
                </div>
            <div class="col-org col-gc" id="colGC">
                <div class="col-title" style="color:#3fb950">Guardia Civil</div>
                </div>
        </div>

    </div>

    <div class="sidebar">
        <h3>Panel de Fichaje</h3>

        <div class="status-display">
            <div style="font-size:11px; color:#8b949e; margin-bottom:4px;">Tu Estado</div>
            <div id="info" style="font-weight:bold; font-size:1.2rem; color:#fff;">Fuera de Servicio</div>
        </div>

        <form id="formUnidad">
            <div id="selUnitDisplay" class="selected-unit-display"></div>

            <div class="form-group">
                <label>N√∫mero de Placa</label>
                <input id="placa" placeholder="Ej: 1234" required autocomplete="off">
            </div>

            <div class="form-group">
                <label>Estado del Agente</label>
                <select id="estado">
                    <option value="disponible">üü¢ Disponible</option>
                    <option value="ocupado">üî¥ Ocupado</option>
                </select>
            </div>

            <select id="unidadBase" style="display:none;"><option value="" disabled selected>Unidad</option></select>
            <select id="subUnidad" style="display:none;"><option value="" disabled selected>Sub</option></select>
            
            <button type="submit">ENTRAR EN SERVICIO</button>
            <button type="button" id="salir" class="gris" style="display:none;">SALIR</button>
            <button type="button" id="cambiarPlaca" class="rojo">LIBERAR PLACA</button>
        </form>
    </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, onValue, remove, get } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

/* === CONFIGURACI√ìN COMPLETA === */
// Aqu√≠ est√°n todas las unidades que pediste

const CONFIG_CONJUNTA = {
    "CONJUNTO": ["Conjunto 1", "Conjunto 2", "Operativo"]
};

const CONFIG_CNP = {
    "JEFATURA CNP": ["H50", "Mando", "Despacho", "Jefe Sala"],
    "Z (Radio Patrulla)": ["Z-10","Z-20","Z-30","Z-40","Z-50","Z-60","Z-70"],
    "K (Camuflado)": ["K-1","K-2","K-3","K-4", "Investigaci√≥n"],
    "UIP (Antidisturbios)": ["UIP 1","UIP 2","UIP 3", "Operativo"],
    "UPR (Bronce)": ["Bronce 1","Bronce 2", "Operativo"],
    "GEO": ["GEO 1", "GEO 2", "Operativo"],
    "GOES": ["GOES 1", "GOES 2", "Operativo"],
    "EXTRANJER√çA": ["Ext-1", "Ext-2"]
};

const CONFIG_GC = {
    "JEFATURA GC": ["H50", "Mando", "Oficial"], 
    "SEGURIDAD CIUDADANA": ["Patrulla 1", "Patrulla 2", "Patrulla 3", "Patrulla 4"],
    "TR√ÅFICO": ["Motorista 1", "Motorista 2", "Atestados", "Radar", "Cot"],
    "GRS": ["GRS 1", "GRS 2", "Operativo"],
    "SEPRONA": ["Patrulla Rural", "Quad"],
    "UEI": ["UEI 1", "Operativo"],
    "POLIC√çA JUDICIAL": ["PJ 1", "Laboratorio"]
};

const ALL_CONFIG = { ...CONFIG_CONJUNTA, ...CONFIG_CNP, ...CONFIG_GC };

const app = initializeApp({
    apiKey: "AIzaSyAkho8Wvxnygmbl0pRXKGUjBIIP3qyEtK8",
    databaseURL: "https://proyecto-erlc-default-rtdb.europe-west1.firebasedatabase.app"
});

const db = getDatabase(app);

// Variables DOM
const colComun = document.getElementById("colComun");
const colCNP = document.getElementById("colCNP");
const colGC = document.getElementById("colGC");

const placa = document.getElementById("placa");
const selBase = document.getElementById("unidadBase");
const selSub = document.getElementById("subUnidad");
const estadoSel = document.getElementById("estado");
const info = document.getElementById("info");
const btnSalir = document.getElementById("salir");
const selUnitDisplay = document.getElementById("selUnitDisplay");

let miPlaca = localStorage.getItem("ffccse_placa");

// Llenar select base oculto para validar
function llenarSelectBase(){
    selBase.innerHTML = "";
    for(let k in ALL_CONFIG) selBase.innerHTML += `<option value="${k}">${k}</option>`;
}
llenarSelectBase();

// Funci√≥n Principal de Renderizado
function renderSection(config, container, dbData) {
    const existing = container.querySelectorAll(".unidad-base");
    existing.forEach(e => e.remove());

    for (const catName in config) {
        const wrap = document.createElement("div");
        wrap.className = "unidad-base";
        wrap.innerHTML = `<h3>${catName}</h3>`;

        const grid = document.createElement("div");
        grid.className = "sub-grid";

        config[catName].forEach(unitName => {
            const box = document.createElement("div");
            box.className = "sub-box";
            
            let content = `<strong>${unitName}</strong>`;
            
            // Contadores para color
            let totalAgents = 0;
            let countDisponible = 0;
            let countOcupado = 0;

            if(dbData[catName] && dbData[catName][unitName]) {
                const occupants = dbData[catName][unitName];
                for(let p in occupants) {
                    totalAgents++;
                    const est = occupants[p].estado;
                    if(est === 'disponible') countDisponible++;
                    else countOcupado++;
                    
                    // Badge individual
                    const colorBadge = est === 'ocupado' ? '#da3633' : '#238636';
                    content += `<div class="mini-badge" style="background:${colorBadge}">${p}</div>`;
                }
            } else {
                content += `<div style="color:#444; font-size:10px;">Libre</div>`;
            }

            // APLICAR COLORES AL CUADRO
            if(totalAgents > 0) {
                if(countDisponible === totalAgents) {
                    box.classList.add("box-green"); // Todos disponibles
                } else if(countOcupado === totalAgents) {
                    box.classList.add("box-red"); // Todos ocupados
                } else {
                    box.classList.add("box-yellow"); // Mezcla
                }
            }

            box.innerHTML = content;

            // Click Handler
            box.onclick = () => {
                selBase.value = catName;
                selSub.innerHTML = "";
                const opt = document.createElement("option");
                opt.value = unitName;
                opt.text = unitName;
                opt.selected = true;
                selSub.appendChild(opt);

                // Feedback visual
                selUnitDisplay.style.display = "block";
                selUnitDisplay.innerHTML = `Seleccionado: <strong>${unitName}</strong>`;
                
                // Resaltar borde selecci√≥n
                document.querySelectorAll(".sub-box").forEach(b => b.style.outline = "none");
                box.style.outline = "2px solid #facc15";

                // Focus inteligente
                if(miPlaca) document.querySelector("button[type='submit']").focus();
                else placa.focus();
            };

            grid.appendChild(box);
        });

        wrap.appendChild(grid);
        container.appendChild(wrap);
    }
}

// Escuchar cambios en Firebase
onValue(ref(db, "unidades_ffccse"), snap => {
    const data = snap.val() || {};

    renderSection(CONFIG_CONJUNTA, colComun, data);
    renderSection(CONFIG_CNP, colCNP, data);
    renderSection(CONFIG_GC, colGC, data);

    if (miPlaca) {
        placa.value = miPlaca;
        placa.disabled = true;
        info.innerHTML = `<span style="color:#facc15">${miPlaca}</span>`;
        btnSalir.style.display = "block";
    } else {
        info.textContent = "Fuera de Servicio";
        btnSalir.style.display = "none";
    }
});

// Entrar en servicio
document.getElementById("formUnidad").onsubmit = async e => {
    e.preventDefault();
    if(!selBase.value || !selSub.value) {
        alert("‚ö†Ô∏è Selecciona una unidad en el panel izquierdo.");
        return;
    }

    if (!miPlaca) {
        miPlaca = placa.value.trim();
        if(!miPlaca) return;
        localStorage.setItem("ffccse_placa", miPlaca);
    }

    await salirDeTodo();

    const path = `unidades_ffccse/${selBase.value}/${selSub.value}/${miPlaca}`;
    await set(ref(db, path), {
        estado: estadoSel.value,
        timestamp: Date.now()
    });
    
    // Reset visual
    selUnitDisplay.innerHTML = "‚úÖ Asignado";
    setTimeout(() => { selUnitDisplay.style.display = "none"; }, 2000);
    document.querySelectorAll(".sub-box").forEach(b => b.style.outline = "none");
};

// Salir de servicio
async function salirDeTodo() {
    if(!miPlaca) return;
    const s = await get(ref(db, "unidades_ffccse"));
    const d = s.val();
    if(!d) return;

    for(let base in d) {
        for(let sub in d[base]) {
            if(d[base][sub][miPlaca]) {
                await remove(ref(db, `unidades_ffccse/${base}/${sub}/${miPlaca}`));
            }
        }
    }
}

btnSalir.onclick = async () => {
    await salirDeTodo();
};

document.getElementById("cambiarPlaca").onclick = async () => {
    if(confirm("¬øSeguro que quieres liberar tu placa?")){
        await salirDeTodo();
        localStorage.removeItem("ffccse_placa");
        miPlaca = null;
        placa.disabled = false;
        placa.value = "";
        info.textContent = "Fuera de Servicio";
        btnSalir.style.display = "none";
    }
};

</script>

</body>
</html>

