<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Informe Policial - Guardia Civil</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: "Times New Roman", Times, serif;
      margin: 20px;
      background-color: #031626;
      color: #333;
    }

    h1 {
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      color: #c5a059;
      margin-bottom: 30px;
    }

    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }

    input, textarea, select {
      width: 100%;
      max-width: 600px;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    button {
      margin-top: 20px;
      padding: 12px 24px;
      background-color: #1a1a1a;
      color: white;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background-color: #333;
    }

    .form-container {
      background-color: #fff;
      border: 1px solid #ddd;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-radius: 8px;
      margin-top: 30px;
    }

    canvas {
      border: 1px solid #000;
      touch-action: none;
      max-width: 100%;
      height: 200px;
    }
  </style>
</head>
<body>
  <h1>Informe Policial - Guardia Civil</h1>

  <div class="form-container">
    <form id="informeForm">
      <label>Número de informe (automático):
        <input type="text" id="numInforme" readonly>
      </label>

      <label>Nombre del agente:
        <input type="text" id="agente" required>
      </label>

      <label>Número de placa / Identificador:
        <input type="text" id="placa" required>
      </label>

      <label>Fecha del informe:
        <input type="date" id="fecha" required>
      </label>

      <label>Lugar / Unidad:
        <input type="text" id="lugar" required>
      </label>

      <label>Tipo de informe:
        <select id="tipoInforme">
          <option>Robo / Hurto</option>
          <option>Asalto / Delito violento</option>
          <option>Investigación / Operación</option>
          <option>Accidente / Incidente</option>
          <option>Otros</option>
        </select>
      </label>

      <label>Descripción de los hechos:
        <textarea id="hechos" rows="5" required></textarea>
      </label>

      <label>Medidas adoptadas:
        <textarea id="medidas" rows="4" required></textarea>
      </label>

      <label>Observaciones adicionales:
        <textarea id="observaciones" rows="3"></textarea>
      </label>

      <label>Firma del superior o responsable (dibujar en pantalla):</label>
      <canvas id="firmaCanvas" width="600" height="200"></canvas>
      <button type="button" onclick="limpiarFirma()">Limpiar firma</button>

      <label>Pie de firma:
        <input type="text" id="pieFirma" placeholder="Ej: Teniente Coronel">
      </label>

      <label>Contraseña para generar PDF:
        <input type="text" id="contrasena" placeholder="Introduce la contraseña">
      </label>

      <br>
      <button type="button" onclick="verificarYGenerarPDF()">Generar Informe PDF</button>
    </form>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const hoy = new Date();
      const num = "GC-INF-" + hoy.getFullYear() + String(hoy.getMonth()+1).padStart(2,'0') + String(hoy.getDate()).padStart(2,'0') + "-" + Math.floor(Math.random()*10000);
      document.getElementById("numInforme").value = num;
    });

    function formatearFecha(fechaStr) {
      const [a,m,d] = fechaStr.split("-");
      return `${d}/${m}/${a}`;
    }

    function limpiarFirma() {
      const canvas = document.getElementById("firmaCanvas");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0,0,canvas.width,canvas.height);
    }

    const canvas = document.getElementById("firmaCanvas");
    const ctx = canvas.getContext("2d");
    let dibujando=false;

    const iniciarDibujo=(x,y)=>{dibujando=true; ctx.beginPath(); ctx.moveTo(x,y);}
    const trazarLinea=(x,y)=>{if(!dibujando) return; ctx.lineTo(x,y); ctx.stroke();}
    const detenerDibujo=()=>{dibujando=false; ctx.closePath();}

    canvas.addEventListener("mousedown", e=>iniciarDibujo(e.offsetX,e.offsetY));
    canvas.addEventListener("mousemove", e=>trazarLinea(e.offsetX,e.offsetY));
    canvas.addEventListener("mouseup", detenerDibujo);
    canvas.addEventListener("mouseout", detenerDibujo);
    canvas.addEventListener("touchstart", e=>{e.preventDefault(); const rect=canvas.getBoundingClientRect(); const touch=e.touches[0]; iniciarDibujo(touch.clientX-rect.left, touch.clientY-rect.top);});
    canvas.addEventListener("touchmove", e=>{e.preventDefault(); const rect=canvas.getBoundingClientRect(); const touch=e.touches[0]; trazarLinea(touch.clientX-rect.left, touch.clientY-rect.top);});
    canvas.addEventListener("touchend", detenerDibujo);

    function verificarYGenerarPDF(){
      const pass=document.getElementById("contrasena").value;
      if(pass==="Cnp!38rT&kWx"||pass==="Adm&85vK#dRt7"){
        generarInformePDF();
      }else{
        alert("⚠️ Contraseña incorrecta. No se generó el informe.");
      }
    }

    async function generarInformePDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const informe=document.getElementById("numInforme").value;
      const placa=document.getElementById("placa").value;
      const agente=document.getElementById("agente").value;
      const fecha=formatearFecha(document.getElementById("fecha").value);
      const lugar=document.getElementById("lugar").value;
      const tipoInforme=document.getElementById("tipoInforme").value;
      const hechos=document.getElementById("hechos").value;
      const medidas=document.getElementById("medidas").value;
      const observaciones=document.getElementById("observaciones").value;
      const pieFirma=document.getElementById("pieFirma").value;

      doc.setFontSize(16); doc.setFont("times","bold");
      doc.text("Guardia Civil",20,20);
      doc.setFontSize(14);
      doc.text(`Informe Policial: ${informe}`,20,30);

      doc.setFontSize(12); doc.setFont("times","normal");
      doc.text(`Fecha: ${fecha}`,20,40);
      doc.text(`Agente: ${agente} (Identificador: ${placa})`,20,50);
      doc.text(`Lugar / Unidad: ${lugar}`,20,60);
      doc.text(`Tipo de informe: ${tipoInforme}`,20,70);

      let altura=85;
      doc.setFont("times","bold"); doc.text("Descripción de los hechos:",20,altura);
      altura+=8; doc.setFont("times","normal");
      doc.text(doc.splitTextToSize(hechos,170),20,altura); altura+=doc.splitTextToSize(hechos,170).length*7+5;

      doc.setFont("times","bold"); doc.text("Medidas adoptadas:",20,altura);
      altura+=8; doc.setFont("times","normal");
      doc.text(doc.splitTextToSize(medidas,170),20,altura); altura+=doc.splitTextToSize(medidas,170).length*7+5;

      if(observaciones.trim()){
        doc.setFont("times","bold"); doc.text("Observaciones adicionales:",20,altura);
        altura+=8; doc.setFont("times","normal");
        doc.text(doc.splitTextToSize(observaciones,170),20,altura); altura+=doc.splitTextToSize(observaciones,170).length*7+5;
      }

      doc.text("Firma del superior o responsable:",20,altura+20);
      const firmaCanvas=document.getElementById("firmaCanvas");
      const firmaImg=firmaCanvas.toDataURL("image/png");
      doc.addImage(firmaImg,"PNG",60,altura+20,100,40);

      if(pieFirma.trim()){ doc.text(`PD. ${pieFirma}`,20,altura+70); }

      doc.save(`InformePolicial_GC_${informe}.pdf`);
    }
  </script>
</body>
</html>
