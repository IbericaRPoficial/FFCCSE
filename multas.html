<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Boletín de Denuncia de Tráfico</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{ background:#cfcfcf; font-family: Arial, sans-serif; margin:0; }
.container{ max-width:980px; margin:20px auto; background:#fff; padding:25px; border-radius:6px; box-shadow:0 0 18px rgba(0,0,0,.3); }
.header{ text-align:center; border-bottom:4px double #000; padding-bottom:10px; }
.header h1{ margin:0; font-size:22px; letter-spacing:1px; }
.section{ margin-top:18px; }
.section h3{ background:#000; color:#fff; font-size:13px; padding:6px 10px; margin:0 0 10px 0; }
.grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px; }
.grid-firmas { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
label{ font-size:11px; font-weight:bold; }
input, textarea, select{ width:100%; padding:6px; font-size:12px; border:1px solid #777; border-radius:3px; box-sizing: border-box;}
canvas{ width:100%; height:150px; border:1px solid #000; background:#fff; touch-action:none; transition: background 0.3s; }
.btn{ padding:8px 10px; font-size:12px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; margin-top: 5px; }
.btn-primary{background:#003b8f;color:#fff; width: 100%; padding: 15px; font-size: 16px;}
.btn-danger{background:#8b0000;color:#fff}
.btn-success{background:#28a745;color:#fff}
.code-badge { float: right; background: #444; padding: 0px 8px; border-radius: 4px; font-size: 10px; color: #fff; }

.checkbox-negativa { margin-top: 10px; display: flex; align-items: center; gap: 8px; background: #f9f9f9; padding: 5px; border-radius: 4px; border: 1px solid #ddd; }
.checkbox-negativa input { width: 18px; height: 18px; cursor: pointer; }
.checkbox-negativa label { color: #8b0000; cursor: pointer; }

@media (max-width: 600px) { .grid-firmas { grid-template-columns: 1fr; } }
</style>
</head>

<body>

<div class="container">
    <div class="header">
        <h1>BOLETÍN DE MULTA</h1>
        <p>Documento Administrativo · Fuerzas y Cuerpos de Seguridad</p>
        <strong>Nº Expediente: <span id="numExp"></span></strong>
    </div>

    <div class="section">
        <h3>DATOS DEL EXPEDIENTE</h3>
        <div class="grid">
            <div><label>Fecha</label><input type="date" id="fecha" placeholder="dd/mm/aaaa"></div>
            <div><label>Hora</label><input type="time" id="hora" placeholder="hh:mm"></div>
            <div><label>Lugar exacto (Muy preciso)</label><input id="lugar" placeholder="Granjas 601 - Frente la Gasolinera"></div>
            <div><label>Nº Servicios</label><input id="municipio" placeholder="2-Sanitarios 1-GC 2-CNP"></div>
        </div>
    </div>

    <div class="section">
        <h3>CONDUCTOR / TITULAR</h3>
        <div class="grid">
            <div><label>Nombre completo</label><input id="nombre" placeholder="Jose Carlos Garcia Marquez"></div>
            <div><label>DNI / NIE</label><input id="dni" placeholder="12345678Z"></div>
            <div><label>Domicilio</label><input id="domicilio" placeholder="Housing Surburb - 7054"></div>
        </div>
    </div>

    <div class="section">
        <h3>VEHÍCULO</h3>
        <div class="grid">
            <div><label>Matrícula</label><input id="matricula" placeholder="ABC123"></div>
            <div><label>Marca / Modelo</label><input id="vehiculo" placeholder="Chevlon Corvetta 2014"></div>
            <div><label>Color</label><input id="color" placeholder="Blanco"></div>
        </div>
    </div>

    <div class="section">
        <h3>INFRACCIÓN DENUNCIADA</h3>
        <div class="grid">
            <div><label>Precepto infringido (Articulos)</label><input id="articulo" placeholder="Art. 5.2 del Reglamento General de Circulación"></div>
            <div>
                <label>Gravedad</label>
                <select id="tipo">
                    <option>Leve</option>
                    <option selected>Media</option>
                    <option>Grave</option>
                    <option>Muy Grave</option>
                </select>
            </div>
            <div><label>Importe (€)</label><input id="importe" placeholder="200"></div>
            <div><label>Puntos</label><input id="puntos" placeholder="4"></div>
        </div>
        <div style="margin-top:10px;">
            <label>Hechos observados</label>
            <textarea id="hechos" rows="4" placeholder="El conductor circulaba a una velocidad superior a la permitida en vía urbana limitada a 50 km/h, siendo detectado a 78 km/h mediante cinemómetro debidamente homologado. Los hechos fueron observados y verificados por el agente denunciante, procediendo a la detención del vehículo en condiciones de seguridad."></textarea>
        </div>
    </div>

    <div class="section">
        <h3>DATOS DEL AGENTE</h3>
        <div class="grid">
            <div><label>Nº Placa</label><input id="placa" placeholder="CNP-XXX / GC-XXX"></div>
            <div><label>Unidad</label><input id="unidad" placeholder="Z-XX / SIERRA-XX"></div>
        </div>
    </div>

    <div class="section">
        <h3>DILIGENCIAS Y OBSERVACIONES</h3>
        <textarea id="diligencias" rows="3" placeholder="Anotaciones adicionales, comportamiento del interesado, testigos..."></textarea>
    </div>

    <div class="section">
        <div class="grid-firmas">
            <div>
                <h3>FIRMA DENUNCIADO <a href="https://ibericarpoficial.github.io/otros/firmar" target="_blank"><span  class="code-badge">ID: <span id="randomCode">....</span></a></span></h3>
                <canvas id="firmaCiudadano"></canvas>
                <button class="btn btn-success" id="btnLoadFirma">Cargar Remota</button>
                <button class="btn btn-danger" onclick="limpiar('firmaCiudadano')">Limpiar</button>
                
                <div class="checkbox-negativa">
                    <input type="checkbox" id="negativaFirma" onclick="manejarNegativaFirma()">
                    <label for="negativaFirma">Negativa a firmar / Imposibilidad</label>
                </div>
            </div>
            <div>
                <h3>FIRMA DEL AGENTE</h3>
                <canvas id="firmaAgente"></canvas>
                <button class="btn btn-danger" onclick="limpiar('firmaAgente')">Limpiar Firma Agente</button>
            </div>   
        </div>
    </div>
           <div class="actions">
        <button class="btn btn-primary" onclick="generarPDF()">GENERAR PDF OFICIAL PROFESIONAL</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, get, child, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyAsAVsv0iwnv4cdDNkSyo1jBIYvCyn_pCY",
    authDomain: "rascay-d6d3d.firebaseapp.com",
    databaseURL: "https://rascay-d6d3d-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "rascay-d6d3d",
    storageBucket: "rascay-d6d3d.firebasestorage.app",
    appId: "1:991120220829:web:15c8dfa4677f701e582a74"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const currentCode = Math.floor(1000 + Math.random() * 9000).toString();
document.getElementById('randomCode').innerText = currentCode;

// FIRMA REMOTA
document.getElementById('btnLoadFirma').onclick = async () => {
    if(document.getElementById('negativaFirma').checked) return;

    const dbRef = ref(db);
    try {
        const snapshot = await get(child(dbRef, `drawings/${currentCode}`));
        if (snapshot.exists()) {
            const canvas = document.getElementById('firmaCiudadano');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width / (window.devicePixelRatio || 1), canvas.height / (window.devicePixelRatio || 1));
            };
            img.src = snapshot.val().imageB64;
        } else { alert("Código no encontrado."); }
    } catch (e) { console.error(e); }
};

// EXPEDIENTE ÚNICO FIREBASE
let expedienteActual = null;
async function obtenerExpedienteActual() {
    const counterRef = ref(db, 'counters/expedienteDT');
    await runTransaction(counterRef, (current) => {
        if (current === null) return 1000;
        return current;
    });
    const snapshot = await get(counterRef);
    expedienteActual = snapshot.val();
    document.getElementById("numExp").textContent = "DT-" + expedienteActual;
}
obtenerExpedienteActual();
</script>

<script>
// --- LÓGICA DE FIRMAS ---
function prepararCanvasFirma(id){
    const canvas = document.getElementById(id);
    const ctx = canvas.getContext("2d");
    const ratio = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * ratio; canvas.height = rect.height * ratio;
    ctx.scale(ratio, ratio);
    ctx.lineWidth = 2; ctx.lineCap = "round";
    let dibujando = false;
    const getPos = (e) => {
        const r = canvas.getBoundingClientRect();
        const cX = e.touches ? e.touches[0].clientX : e.clientX;
        const cY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: cX - r.left, y: cY - r.top };
    };
    canvas.addEventListener("mousedown", (e) => { 
        if(canvas.style.pointerEvents === "none") return;
        dibujando = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); 
    });
    canvas.addEventListener("mousemove", (e) => { if(dibujando){ const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); } });
    window.addEventListener("mouseup", () => dibujando = false);
    canvas.addEventListener("touchstart", (e) => { 
        if(canvas.style.pointerEvents === "none") return;
        e.preventDefault(); dibujando=true; ctx.beginPath(); const p=getPos(e); ctx.moveTo(p.x,p.y); 
    }, {passive:false});
    canvas.addEventListener("touchmove", (e) => { e.preventDefault(); if(dibujando){ const p=getPos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); } }, {passive:false});
}
function limpiar(id){
    const c = document.getElementById(id);
    c.getContext("2d").clearRect(0,0,c.width,c.height);
}
function manejarNegativaFirma() {
    const checkbox = document.getElementById('negativaFirma');
    const canvas = document.getElementById('firmaCiudadano');
    const ctx = canvas.getContext('2d');
    
    if (checkbox.checked) {
        limpiar('firmaCiudadano');
        ctx.fillStyle = "#8b0000";
        ctx.font = "bold 16px Arial";
        ctx.textAlign = "center";
        const xPos = canvas.width / (2 * (window.devicePixelRatio || 1));
        ctx.fillText("EL DENUNCIADO SE NIEGA A FIRMAR", xPos, 60);
        ctx.fillText("O EXISTE IMPOSIBILIDAD FÍSICA", xPos, 85);
        canvas.style.pointerEvents = "none";
        canvas.style.backgroundColor = "#fce8e8";
    } else {
        limpiar('firmaCiudadano');
        canvas.style.pointerEvents = "auto";
        canvas.style.backgroundColor = "#fff";
    }
}
prepararCanvasFirma("firmaCiudadano");
prepararCanvasFirma("firmaAgente");

// --- GENERAR PDF ---
async function generarPDF() {
    const { jsPDF } = window.jspdf;

    // INCREMENTO EXPEDIENTE FIREBASE
    const counterRef = firebase.database().ref('counters/expedienteDT');
    await runTransaction(counterRef, (current) => {
        if (current === null) return 1000;
        return current + 1;
    });
    const snapshot = await get(counterRef);
    expedienteActual = snapshot.val();

    const pdf = new jsPDF("p","mm","a4");
    const margin=15;
    let y=20;
    pdf.setFont("helvetica","bold");
    pdf.setFontSize(16);
    pdf.text("BOLETÍN DE DENUNCIA DE TRÁFICO",105,y,{align:"center"});
    y+=8;
    pdf.setFontSize(10);
    pdf.setFont("helvetica","normal");
    pdf.text("Documento Administrativo · Fuerzas y Cuerpos de Seguridad",105,y,{align:"center"});
    y+=10;
    pdf.line(margin,y,210-margin,y);
    y+=8;
    pdf.setFont("helvetica","bold");
    pdf.text("EXPEDIENTE Nº: DT-"+expedienteActual,margin,y);
    y+=10;

    const drawSection=(title,data)=>{
        pdf.setFillColor(240,240,240);
        pdf.rect(margin,y,180,7,'F');
        pdf.setFont("helvetica","bold");
        pdf.text(title,margin+2,y+5);
        y+=12;
        pdf.setFont("helvetica","normal");
        data.forEach(item=>{
            pdf.setFont("helvetica","bold");
            pdf.text(item[0]+":",margin,y);
            pdf.setFont("helvetica","normal");
            pdf.text(item[1]||"---",margin+40,y);
            y+=6;
        });
        y+=5;
    };

    drawSection("DATOS DEL HECHO",[
        ["Fecha y Hora",document.getElementById("fecha").value+" / "+document.getElementById("hora").value],
        ["Lugar",document.getElementById("lugar").value],
        ["Nº Servicios",document.getElementById("municipio").value]
    ]);
    drawSection("IDENTIFICACIÓN DEL CONDUCTOR",[
        ["Nombre",document.getElementById("nombre").value],
        ["DNI/NIE",document.getElementById("dni").value],
        ["Domicilio",document.getElementById("domicilio").value]
    ]);
    drawSection("VEHÍCULO",[
        ["Matrícula",document.getElementById("matricula").value],
        ["Marca/Modelo",document.getElementById("vehiculo").value],
        ["Color",document.getElementById("color").value]
    ]);
    drawSection("DATOS DE LA INFRACCIÓN",[
        ["Precepto",document.getElementById("articulo").value],
        ["Gravedad",document.getElementById("tipo").value],
        ["Importe",document.getElementById("importe").value+" €"],
        ["Puntos",document.getElementById("puntos").value]
    ]);

    pdf.setFont("helvetica","bold");
    pdf.text("HECHOS OBSERVADOS:",margin,y); y+=5;
    pdf.setFont("helvetica","normal");
    pdf.text(pdf.splitTextToSize(document.getElementById("hechos").value,180),margin,y);
    y+=20;

    pdf.text("DILIGENCIAS / OBSERVACIONES:",margin,y); y+=5;
    pdf.setFont("helvetica","normal");
    pdf.text(pdf.splitTextToSize(document.getElementById("diligencias").value,180),margin,y);

    // FIRMA
    const firmaC = document.getElementById("firmaCiudadano").toDataURL("image/png");
    const firmaA = document.getElementById("firmaAgente").toDataURL("image/png");
    pdf.addImage(firmaC,'PNG',margin, y+10, 80,40);
    pdf.addImage(firmaA,'PNG',110, y+10, 80,40);

    pdf.save("DT-"+expedienteActual+".pdf");
}
</script>

</body>
</html>
